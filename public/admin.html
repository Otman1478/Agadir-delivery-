<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Agadir Delivery</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <h1>üèçÔ∏è Admin - Agadir Delivery</h1>
        <nav id="admin-nav" style="display: none;">
            <ul>
                <li><a href="#" onclick="showAdminPage('manage-categories')"><i class="fas fa-tags"></i> Manage Categories</a></li>
                <li><a href="#" onclick="showAdminPage('add-product')"><i class="fas fa-plus-circle"></i> Add Product</a></li>
                <li><a href="#" onclick="showAdminPage('delete-products')"><i class="fas fa-trash-alt"></i> Delete Products</a></li>
                <li><a href="#" onclick="showAdminPage('manage-orders')"><i class="fas fa-clipboard-list"></i> Manage Orders</a></li>
                <li><a href="index.html"><i class="fas fa-home"></i> Back to Home</a></li>
                <li><a href="#" onclick="logout()" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
            <button class="dark-mode-toggle" title="Toggle Dark Mode">
                <i class="fas fa-moon"></i>
                <i class="fas fa-sun" style="display: none;"></i>
            </button>
            <button class="profile-toggle" title="Profile/Settings">
                <i class="fas fa-user"></i>
            </button>
        </nav>
    </header>

    <main>
        <section id="login" class="page active">
            <h2>Admin Login</h2>
            <form id="login-form">
                <input type="password" id="admin-password" placeholder="Password" required>
                <button type="submit">Login</button>
            </form>
            <div id="login-notification" class="notification"></div>
        </section>

        <section id="manage-categories" class="page">
            <h2>Manage Categories</h2>
            <form id="category-form">
                <input type="text" id="category-name" placeholder="Category Name (e.g., Grocery)" required>
                <button type="submit">Add Category</button>
            </form>
            <div id="category-list" class="category-list"></div>
            <div id="category-notification" class="notification"></div>
        </section>

        <section id="add-product" class="page">
            <h2>Add Product</h2>
            <form id="product-form" enctype="multipart/form-data">
                <input type="text" id="product-name-en" name="name_en" placeholder="Product Name (English)" required>
                <input type="text" id="product-name-fr" name="name_fr" placeholder="Product Name (French)" required>
                <input type="text" id="product-name-ar" name="name_ar" placeholder="Product Name (Arabic)" required>
                <input type="number" id="product-price" name="price" placeholder="Original Price (DH)" step="0.01" required>
                <input type="number" id="product-discount" name="discount" placeholder="Discount (%) - Optional" step="0.01" min="0" max="100">
                <select id="product-category" name="category" required>
                    <option value="" disabled selected>Select Category</option>
                    <option value="grocery">Grocery</option>
                    <option value="food">Food</option>
                    <option value="clothes">Clothes</option>
                    <option value="special-offers">Special Offers</option>
                    <option value="animals">Animals</option>
                    <option value="accessories">Accessories</option>
                    <option value="electronics">Electronics</option>
                    <option value="special-events">Special Events</option>
                    <option value="make-up">Make-up</option>
                    <option value="babies">Babies</option>
                    <option value="toys">Toys</option>
                    <option value="kids-clothing">Kids Clothing</option>
                    <option value="meats">Meats</option>
                    <option value="sports">Sports</option>
                    <option value="drinks">Drinks</option>
                </select>
                <input type="file" id="product-images" name="images" accept="image/*" multiple required>
                <textarea id="product-description" name="description" placeholder="Product Description" rows="4"></textarea>
                <button type="submit">Add Product</button>
            </form>
            <div id="product-add-notification" class="notification"></div>
        </section>

        <section id="delete-products" class="page">
            <h2>Delete Products</h2>
            <table id="product-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name (EN)</th>
                        <th>Name (FR)</th>
                        <th>Name (AR)</th>
                        <th>Original Price (DH)</th>
                        <th>Discount (%)</th>
                        <th>Discounted Price (DH)</th>
                        <th>Category</th>
                        <th>Main Image</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="product-list"></tbody>
            </table>
            <div id="product-delete-notification" class="notification"></div>
        </section>

        <section id="manage-orders" class="page">
            <h2>Manage Orders</h2>
            <div id="order-count-notification" class="notification"></div>
            <table id="order-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Location</th>
                        <th>Items</th>
                        <th>Total (DH)</th>
                        <th>Time</th>
                        <th>Assigned Admin</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="order-list"></tbody>
            </table>
            <div id="order-notification" class="notification"></div>
        </section>

        <!-- Modal for viewing order items with quantity -->
        <div id="order-items-modal" class="modal">
            <div class="modal-content">
                <h2>Order Items</h2>
                <table id="order-items-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Quantity</th>
                            <th>Image</th>
                        </tr>
                    </thead>
                    <tbody id="order-items-list"></tbody>
                </table>
                <button class="back-btn" onclick="closeOrderItemsModal()">Back</button>
            </div>
        </div>

        <!-- Authentication Modal -->
        <div id="auth-modal" class="modal">
            <div class="modal-content">
                <section id="signin" class="auth-page active">
                    <h2>Admin Sign In</h2>
                    <form id="signin-form">
                        <input type="email" id="signin-email" placeholder="Email" required>
                        <input type="password" id="signin-password" placeholder="Password" required>
                        <button type="submit">Sign In</button>
                        <button type="button" id="to-forgot">Forgot Password?</button>
                    </form>
                </section>
                <section id="forgot-password" class="auth-page">
                    <h2>Forgot Password</h2>
                    <form id="forgot-form">
                        <input type="email" id="forgot-email" placeholder="Email" required>
                        <button type="submit">Reset Password</button>
                        <button type="button" id="to-signin-from-forgot">Back to Sign In</button>
                    </form>
                </section>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <section id="settings">
                    <h2>Admin Settings</h2>
                    <form id="settings-form">
                        <input type="text" id="settings-username" placeholder="Username" required>
                        <input type="email" id="settings-email" placeholder="Email" required>
                        <input type="password" id="settings-password" placeholder="New Password (optional)">
                        <button type="submit">Save Changes</button>
                        <button type="button" class="back-btn" id="close-settings-modal">Close</button>
                    </form>
                </section>
            </div>
        </div>
    </main>

    <footer>
        <p>¬© 2025 Agadir Delivery. All rights reserved.</p>
    </footer>

    <script>
        const ADMIN_PASSWORD = 'admin123';
        let categories = [
            'grocery', 'food', 'clothes', 'special-offers', 'animals', 'accessories',
            'electronics', 'special-events', 'make-up', 'babies', 'toys', 'kids-clothing',
            'meats', 'sports', 'drinks'
        ];
        let connectedAdmins = [];
        let adminAssignments = {};
        let isLoggedIn = false;

        function showAdminPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            const pageElement = document.getElementById(pageId);
            if (pageElement) {
                pageElement.classList.add('active');
                if (pageId === 'add-product') loadCategoriesForForm();
                if (pageId === 'delete-products') loadProducts();
                if (pageId === 'manage-orders') {
                    loadOrders();
                    updateOrderCountNotification();
                    assignOrdersToAdmins();
                }
            } else {
                console.error('Admin page element not found:', pageId);
            }
        }

        function showNotification(elementId, message, type = 'success') {
            const notification = document.getElementById(elementId);
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function login(password) {
            if (password === ADMIN_PASSWORD) {
                const adminId = `admin_${Date.now()}`;
                connectedAdmins.push(adminId);
                isLoggedIn = true;
                document.getElementById('admin-nav').style.display = 'block';
                document.getElementById('login').classList.remove('active');
                showAdminPage('manage-categories');
                loadCategories();
                document.querySelector('.profile-toggle i').classList.replace('fa-user', 'fa-cog');
                console.log('Connected admins:', connectedAdmins);
            } else {
                showNotification('login-notification', 'Incorrect password!', 'error');
            }
        }

        function logout() {
            const adminId = connectedAdmins[connectedAdmins.length - 1];
            connectedAdmins = connectedAdmins.filter(id => id !== adminId);
            isLoggedIn = false;
            document.getElementById('admin-nav').style.display = 'none';
            showAdminPage('login');
            document.getElementById('login-form').reset();
            document.querySelector('.profile-toggle i').classList.replace('fa-cog', 'fa-user');
            console.log('Connected admins after logout:', connectedAdmins);
        }

        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            login(password);
        });

        // Dark Mode Toggle
        const darkModeToggle = document.querySelector('.dark-mode-toggle');
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const moon = darkModeToggle.querySelector('.fa-moon');
            const sun = darkModeToggle.querySelector('.fa-sun');
            moon.style.display = moon.style.display === 'none' ? 'inline' : 'none';
            sun.style.display = sun.style.display === 'none' ? 'inline' : 'none';
        });

        // Profile/Settings Toggle
        const profileToggle = document.querySelector('.profile-toggle');
        const authModal = document.getElementById('auth-modal');
        const settingsModal = document.getElementById('settings-modal');

        profileToggle.addEventListener('click', () => {
            if (isLoggedIn) {
                settingsModal.classList.toggle('active');
            } else {
                authModal.classList.toggle('active');
            }
        });

        // Auth Modal Navigation
        const toForgot = document.getElementById('to-forgot');
        const toSigninFromForgot = document.getElementById('to-signin-from-forgot');

        toForgot.addEventListener('click', () => toggleAuthPage('forgot-password'));
        toSigninFromForgot.addEventListener('click', () => toggleAuthPage('signin'));

        function toggleAuthPage(pageId) {
            document.querySelectorAll('.auth-page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        // Auth Form Submissions
        document.getElementById('signin-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            login(password); // Using existing password check for simplicity
            authModal.classList.remove('active');
        });

        document.getElementById('forgot-form').addEventListener('submit', (e) => {
            e.preventDefault();
            console.log('Password reset requested for:', document.getElementById('forgot-email').value);
            showNotification('login-notification', 'Password reset link sent (simulated)!', 'info');
            authModal.classList.remove('active');
        });

        // Settings Form Submission
        document.getElementById('settings-form').addEventListener('submit', (e) => {
            e.preventDefault();
            console.log('Settings saved:', {
                username: document.getElementById('settings-username').value,
                email: document.getElementById('settings-email').value,
                password: document.getElementById('settings-password').value || 'unchanged'
            });
            showNotification('login-notification', 'Settings updated successfully!', 'success');
            settingsModal.classList.remove('active');
        });

        document.getElementById('close-settings-modal').addEventListener('click', () => {
            settingsModal.classList.remove('active');
        });

        function loadCategories() {
            const categoryList = document.getElementById('category-list');
            categoryList.innerHTML = '';
            categories.forEach(category => {
                const div = document.createElement('div');
                div.className = 'category-item';
                div.innerHTML = `
                    <span>${category.charAt(0).toUpperCase() + category.slice(1)}</span>
                    <button class="remove-btn" onclick="deleteCategory('${category}')">Delete</button>
                `;
                categoryList.appendChild(div);
            });
        }

        function deleteCategory(category) {
            categories = categories.filter(cat => cat !== category);
            loadCategories();
            loadCategoriesForForm();
            showNotification('category-notification', `Category "${category}" deleted!`);
        }

        document.getElementById('category-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const categoryName = document.getElementById('category-name').value.trim().toLowerCase();
            if (categoryName && !categories.includes(categoryName)) {
                categories.push(categoryName);
                loadCategories();
                loadCategoriesForForm();
                showNotification('category-notification', `Category "${categoryName}" added!`);
                this.reset();
            } else {
                showNotification('category-notification', 'Category already exists or is invalid!', 'error');
            }
        });

        function loadCategoriesForForm() {
            const categorySelect = document.getElementById('product-category');
            categorySelect.innerHTML = '<option value="" disabled selected>Select Category</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                categorySelect.appendChild(option);
            });
        }

        document.getElementById('product-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const nameEn = document.getElementById('product-name-en').value.trim();
            const nameFr = document.getElementById('product-name-fr').value.trim();
            const nameAr = document.getElementById('product-name-ar').value.trim();
            const price = parseFloat(document.getElementById('product-price').value);
            const discount = document.getElementById('product-discount').value.trim() ? parseFloat(document.getElementById('product-discount').value) : 0;
            const category = document.getElementById('product-category').value;
            const images = document.getElementById('product-images').files;
            const description = document.getElementById('product-description').value.trim();

            if (!nameEn || !nameFr || !nameAr || !price || !category || images.length === 0) {
                showNotification('product-add-notification', 'Please fill all required fields!', 'error');
                return;
            }

            if (discount < 0 || discount > 100) {
                showNotification('product-add-notification', 'Discount must be between 0 and 100!', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('name_en', nameEn);
            formData.append('name_fr', nameFr);
            formData.append('name_ar', nameAr);
            formData.append('price', price);
            formData.append('discount', discount);
            formData.append('category', category);
            formData.append('description', description);
            for (let i = 0; i < images.length; i++) {
                formData.append('images', images[i]);
            }

            fetch('/api/admin/products', {  // Updated endpoint to match server-side
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('product-add-notification', `Product "${nameEn}" added successfully!`);
                    this.reset();
                    loadProducts();
                } else {
                    showNotification('product-add-notification', data.error || 'Error adding product!', 'error');
                }
            })
            .catch(error => {
                console.error('Error adding product:', error);
                showNotification('product-add-notification', 'Error adding product!', 'error');
            });
        });

        function loadProducts() {
            fetch('/api/admin/products')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(products => {
                    const productList = document.getElementById('product-list');
                    productList.innerHTML = '';
                    if (products.length === 0) {
                        productList.innerHTML = '<tr><td colspan="10">No products available. Add some above!</td></tr>';
                    } else {
                        products.forEach(product => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${product.id}</td>
                                <td>${product.name.en}</td>
                                <td>${product.name.fr}</td>
                                <td>${product.name.ar}</td>
                                <td>${product.price}</td>
                                <td>${product.discount}</td>
                                <td>${product.discount > 0 ? product.discountedPrice : 'N/A'}</td>
                                <td>${product.category.charAt(0).toUpperCase() + product.category.slice(1)}</td>
                                <td><img src="${product.images[0]}" alt="${product.name.en}" style="width: 50px; height: 50px; border-radius: 5px;"></td>
                                <td><button class="delete-btn" onclick="deleteProduct(${product.id})">Delete</button></td>
                            `;
                            productList.appendChild(tr);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading products:', error);
                    showNotification('product-delete-notification', 'Error loading products!', 'error');
                });
        }

        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                fetch(`/api/admin/products/${productId}`, {  // Updated endpoint to match server-side
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to delete product');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showNotification('product-delete-notification', 'Product deleted successfully!');
                        loadProducts();
                    } else {
                        showNotification('product-delete-notification', 'Error deleting product!', 'error');
                    }
                })
                .catch(error => {
                    console.error('Delete product error:', error);
                    showNotification('product-delete-notification', 'Error deleting product: ' + error.message, 'error');
                });
            }
        }

        function loadOrders() {
            fetch('/api/admin/orders')  // Updated endpoint to match server-side
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(orders => {
                    const orderList = document.getElementById('order-list');
                    orderList.innerHTML = '';
                    if (orders.length === 0) {
                        orderList.innerHTML = '<tr><td colspan="9">No orders available</td></tr>';
                    } else {
                        orders.forEach(order => {
                            const assignedAdmin = adminAssignments[order.id] || 'Unassigned';
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${order.name}</td>
                                <td>${order.phone}</td>
                                <td>${order.location}</td>
                                <td>
                                    Hidden
                                    <br>
                                    <button class="see-more-btn" onclick="showOrderItemsModal(${order.id})">See More</button>
                                </td>
                                <td>${order.total}</td>
                                <td>${new Date(order.timestamp).toLocaleString()}</td>
                                <td>${assignedAdmin}</td>
                                <td>
                                    <button class="delete-btn" onclick="deleteOrder(${order.id})">Delete</button>
                                </td>
                            `;
                            orderList.appendChild(tr);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading orders:', error);
                    showNotification('order-notification', 'Error loading orders!', 'error');
                });
        }

        function showOrderItemsModal(orderId) {
            fetch('/api/admin/orders')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(orders => {
                    const order = orders.find(o => o.id === orderId);
                    if (!order) {
                        showNotification('order-notification', 'Order not found!', 'error');
                        return;
                    }

                    const items = order.items; // Already parsed by server
                    const orderItemsList = document.getElementById('order-items-list');
                    orderItemsList.innerHTML = '';

                    const modal = document.getElementById('order-items-modal');
                    modal.classList.add('active');

                    if (!items || items.length === 0) {
                        orderItemsList.innerHTML = '<tr><td colspan="3">No items in this order</td></tr>';
                        return;
                    }

                    items.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${item.name} (${order.language})</td>
                            <td>√ó${item.quantity}</td>
                            <td><img src="${item.img}" alt="${item.name}" style="width: 50px; height: 50px; border-radius: 5px;"></td>
                        `;
                        orderItemsList.appendChild(tr);
                    });
                })
                .catch(error => {
                    console.error('Error fetching order:', error);
                    showNotification('order-notification', 'Error loading order details!', 'error');
                    const orderItemsList = document.getElementById('order-items-list');
                    orderItemsList.innerHTML = '<tr><td colspan="3">Error loading items</td></tr>';
                });
        }

        function closeOrderItemsModal() {
            const modal = document.getElementById('order-items-modal');
            modal.classList.remove('active');
        }

        function updateOrderCountNotification() {
            fetch('/api/admin/orders')
                .then(response => response.json())
                .then(orders => {
                    const totalOrders = orders.length;
                    showNotification('order-count-notification', `Total Orders Received: ${totalOrders}`, 'info');
                })
                .catch(error => {
                    console.error('Error fetching orders for count:', error);
                    showNotification('order-count-notification', 'Error loading order count!', 'error');
                });
        }

        function assignOrdersToAdmins() {
            fetch('/api/admin/orders')
                .then(response => response.json())
                .then(orders => {
                    adminAssignments = {};
                    if (connectedAdmins.length === 0) {
                        orders.forEach(order => {
                            adminAssignments[order.id] = 'Unassigned';
                        });
                    } else {
                        const ordersPerAdmin = Math.floor(orders.length / connectedAdmins.length);
                        const remainingOrders = orders.length % connectedAdmins.length;
                        let orderIndex = 0;

                        connectedAdmins.forEach((adminId, index) => {
                            for (let i = 0; i < ordersPerAdmin; i++) {
                                if (orderIndex < orders.length) {
                                    adminAssignments[orders[orderIndex].id] = adminId.slice(-6);
                                    orderIndex++;
                                }
                            }
                            if (index < remainingOrders && orderIndex < orders.length) {
                                adminAssignments[orders[orderIndex].id] = adminId.slice(-6);
                                    orderIndex++;
                            }
                        });
                    }
                    loadOrders();
                })
                .catch(error => {
                    console.error('Error assigning orders:', error);
                    showNotification('order-notification', 'Error assigning orders!', 'error');
                });
        }

        function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order?')) {
                fetch(`/api/admin/orders/${orderId}`, {  // Updated endpoint to match server-side
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to delete order');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showNotification('order-notification', 'Order deleted successfully!');
                        loadOrders();
                        updateOrderCountNotification();
                        assignOrdersToAdmins();
                    } else {
                        showNotification('order-notification', 'Error deleting order!', 'error');
                    }
                })
                .catch(error => {
                    console.error('Delete order error:', error);
                    showNotification('order-notification', 'Error deleting order: ' + error.message, 'error');
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            showAdminPage('login');
            loadCategoriesForForm(); // Ensure categories are loaded into the form on page load
        });
    </script>
</body>
</html>